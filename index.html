<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Pro - Gradient Progress</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root {
            --bg: linear-gradient(135deg, #e0f2fe 0%, #fce7f3 100%);
            --glass: rgba(255, 255, 255, 0.5);
            --border: rgba(255, 255, 255, 0.8);
            --accent: #0ea5e9;
            --pink: #ec4899;
            --grad: linear-gradient(90deg, #0ea5e9, #ec4899, #0ea5e9);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'PingFang SC', sans-serif; }
        body { background: var(--bg); background-attachment: fixed; min-height: 100vh; padding: 2vw; overflow-x: hidden; }

        /* å…¨å±æ‹–æ‹½æé†’ */
        #dragOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(14, 165, 233, 0.2); backdrop-filter: blur(10px);
            z-index: 10000; display: none; align-items: center; justify-content: center;
            border: 10px dashed var(--accent); pointer-events: none; user-select: none;
        }
        #dragOverlay.active { display: flex; }

        .container {
            max-width: 1600px; width: 95%; margin: 0 auto;
            background: var(--glass); backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid var(--border); border-radius: 40px; padding: 30px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.08);
        }

        .layout { display: grid; grid-template-columns: 400px 1fr; gap: 30px; }
        .panel { background: rgba(255, 255, 255, 0.45); border: 1px solid var(--border); border-radius: 30px; padding: 25px; overflow: hidden; }

        /* æ–‡ä»¶åˆ—è¡¨ï¼šé˜²é€‰ä¸­ */
        .file-list { height: 55vh; overflow-y: auto; margin-top: 20px; user-select: none; }
        .item-row { background: rgba(255,255,255,0.7); margin-bottom: 12px; border-radius: 20px; transition: 0.2s; cursor: grab; }
        .item-row:hover { background: white; }
        .item-row.active { border: 1px solid var(--accent); background: white; }
        .item-main { padding: 18px; display: flex; align-items: center; justify-content: space-between; }
        .file-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; pointer-events: none; }

        /* æ¸å˜è¿›åº¦æ¡ */
        .progress-container { width: 100%; height: 12px; background: rgba(0,0,0,0.05); border-radius: 10px; margin: 20px 0; overflow: hidden; display: none; }
        #progressBar { 
            width: 0%; height: 100%; background: var(--grad); background-size: 200% 100%;
            transition: width 0.3s ease; animation: flow 2s linear infinite;
        }
        @keyframes flow { 0% { background-position: 0% 0%; } 100% { background-position: -200% 0%; } }

        /* æ§ä»¶åŒº */
        .preview-box { width: 100%; height: 55vh; background: rgba(255,255,255,0.2); border-radius: 30px; display: flex; align-items: center; justify-content: center; overflow: auto; margin-bottom: 25px; }
        #pCanvas, #pImg { max-width: 98%; max-height: 98%; border-radius: 10px; display: none; }

        .controls { display: flex; flex-wrap: wrap; gap: 15px; }
        select, input { padding: 14px; border-radius: 16px; border: 1px solid var(--border); background: white; flex: 1; outline: none; }

        .btn-group { display: flex; gap: 15px; width: 100%; margin-top: 25px; }
        .btn { flex: 1; padding: 18px; border-radius: 22px; border: none; font-weight: bold; color: white; cursor: pointer; transition: 0.3s; font-size: 1.1rem; }
        .btn-blue { background: linear-gradient(135deg, #0ea5e9, #38bdf8); }
        .btn-pink { background: linear-gradient(135deg, #ec4899, #f472b6); }
        .btn:hover { transform: translateY(-4px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }

        #status { text-align: center; margin-top: 10px; color: var(--accent); font-weight: 600; font-size: 0.9rem; }
    </style>
</head>
<body>

<div id="dragOverlay"><div style="background: white; padding: 40px 80px; border-radius: 40px;"><h1 style="color: var(--accent);">âœ¨ æ¾å¼€å¯¼å…¥</h1></div></div>

<div class="container">
    <div class="layout">
        <div class="panel">
            <div class="upload-area" id="dropZone" style="border:2px dashed var(--accent); border-radius:20px; padding:40px 10px; text-align:center; cursor:pointer; user-select:none;">
                <div style="font-size: 2rem;">ğŸ“‚</div>
                <p style="font-weight: 600; margin-top: 10px;">ç‚¹å‡»æˆ–ç›´æ¥æ‹–å…¥</p>
                <input type="file" id="fileInput" multiple accept=".pdf,image/*" style="display:none;">
            </div>
            <div class="file-list" id="fileList"></div>
        </div>

        <div class="panel">
            <div class="preview-box">
                <canvas id="pCanvas"></canvas><img id="pImg"><p id="hint" style="color:#94a3b8;">åŒå‡»å±•å¼€è¯¦æƒ…</p>
            </div>

            <div class="progress-container" id="pContainer"><div id="progressBar"></div></div>

            <div class="controls">
                <select id="pageSize"><option value="A3">A3 è§„æ ¼</option><option value="A4">A4 è§„æ ¼</option></select>
                <select id="pageOrient"><option value="landscape">æ¨ªå‘æ–¹å‘</option><option value="portrait">çºµå‘æ–¹å‘</option></select>
                <select id="fillMode"><option value="stretch">æ‹‰ä¼¸å¡«å……</option><option value="contain">ç­‰æ¯”å¯¹é½</option></select>
                <input type="text" id="fileName" value="å¯¼å‡ºæ–‡ä»¶å" style="flex:2;">
            </div>

            <div class="btn-group">
                <button class="btn btn-blue" id="mergeBtn">åˆå¹¶ PDF</button>
                <button class="btn btn-pink" id="longImgBtn">ç”Ÿæˆè¶…æ¸…é•¿å›¾</button>
            </div>
            <div id="status"></div>
        </div>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    let filesArray = [];

    // è¿›åº¦æ¡æ§åˆ¶
    function updateProgress(val, show = true) {
        const container = document.getElementById('pContainer');
        const bar = document.getElementById('progressBar');
        container.style.display = show ? 'block' : 'none';
        bar.style.width = val + '%';
    }

    // æ‹–æ‹½é€»è¾‘ä¿æŒ (åŒ…å« overlay)
    const overlay = document.getElementById('dragOverlay');
    window.addEventListener('dragenter', (e) => { e.preventDefault(); overlay.classList.add('active'); });
    overlay.addEventListener('dragleave', (e) => { if (!e.relatedTarget) overlay.classList.remove('active'); });
    window.addEventListener('dragover', (e) => e.preventDefault());
    window.addEventListener('drop', (e) => {
        e.preventDefault(); overlay.classList.remove('active');
        if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
    });

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFiles(e.target.files);

    async function handleFiles(files) {
        msg("âš¡ æ­£åœ¨è§£æ...");
        updateProgress(30);
        for(let file of files) {
            const id = 'id_' + Math.random().toString(36).substr(2, 9);
            let pageCount = 1, pdfDoc = null, pdfBytes = null;
            if(file.type === 'application/pdf') {
                pdfBytes = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument({data: pdfBytes}).promise;
                pageCount = pdfDoc.numPages;
            }
            filesArray.push({ id, file, type: file.type.includes('pdf') ? 'pdf' : 'image', pageCount, pdfDoc, pdfBytes });
        }
        updateProgress(100);
        setTimeout(() => updateProgress(0, false), 500);
        renderUI();
        msg("âœ… å·²æ·»åŠ ");
    }

    function renderUI() {
        const list = document.getElementById('fileList');
        list.innerHTML = '';
        filesArray.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item-row';
            div.id = item.id;
            div.innerHTML = `<div class="item-main"><span class="file-name">${item.pageCount > 1 ? 'ğŸ“‚' : 'ğŸ“„'} ${item.file.name}</span><i style="cursor:pointer;" onclick="event.stopPropagation(); removeF('${item.id}')">âœ•</i></div>`;
            div.onclick = () => {
                document.querySelectorAll('.item-row').forEach(r => r.classList.remove('active'));
                div.classList.add('active');
                previewPage(item.id, 1);
            };
            list.appendChild(div);
        });
    }

    async function previewPage(id, pageNum) {
        const item = filesArray.find(f => f.id === id);
        document.getElementById('hint').style.display = 'none';
        const pCanvas = document.getElementById('pCanvas');
        const pImg = document.getElementById('pImg');
        if(item.type === 'pdf') {
            pImg.style.display = 'none'; pCanvas.style.display = 'block';
            const page = await item.pdfDoc.getPage(pageNum);
            const vp = page.getViewport({scale: 1.2});
            pCanvas.width = vp.width; pCanvas.height = vp.height;
            await page.render({canvasContext: pCanvas.getContext('2d'), viewport: vp}).promise;
        } else {
            pCanvas.style.display = 'none'; pImg.style.display = 'block';
            const reader = new FileReader();
            reader.onload = e => pImg.src = e.target.result;
            reader.readAsDataURL(item.file);
        }
    }

    document.getElementById('longImgBtn').onclick = async () => {
        if(filesArray.length === 0) return;
        msg("ğŸ¨ æ¸²æŸ“é•¿å›¾ä¸­...");
        updateProgress(10);
        const hdScale = 5.0; 
        const isA3 = document.getElementById('pageSize').value === 'A3';
        const targetW = (isA3 ? 1190 : 841) * (hdScale / 1.5);
        let totalH = 0; const queue = [];

        for (let idx = 0; idx < filesArray.length; idx++) {
            const item = filesArray[idx];
            updateProgress(10 + (idx/filesArray.length)*80);
            if(item.type === 'pdf') {
                for(let i=1; i<=item.pageCount; i++) {
                    const page = await item.pdfDoc.getPage(i);
                    const renderScale = targetW / page.getViewport({scale: 1}).width;
                    const vp = page.getViewport({scale: renderScale});
                    const c = document.createElement('canvas');
                    c.width = targetW; c.height = vp.height;
                    await page.render({canvasContext: c.getContext('2d'), viewport: vp}).promise;
                    queue.push(c); totalH += c.height;
                }
            } else {
                const img = await createImageBitmap(item.file);
                const c = document.createElement('canvas');
                c.width = targetW; c.height = img.height * (targetW / img.width);
                c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                queue.push(c); totalH += c.height;
            }
        }
        const final = document.createElement('canvas');
        final.width = targetW; final.height = totalH;
        const fctx = final.getContext('2d');
        let y = 0; queue.forEach(c => { fctx.drawImage(c, 0, y); y += c.height; });
        updateProgress(95);
        final.toBlob(b => { 
            saveAs(b, `${document.getElementById('fileName').value}_HD.png`); 
            msg("âœ¨ å¯¼å‡ºå®Œæˆ");
            updateProgress(100);
            setTimeout(() => updateProgress(0, false), 800);
        }, 'image/png');
    };

    document.getElementById('mergeBtn').onclick = async () => {
        if(filesArray.length === 0) return;
        msg("ğŸ“š åˆå¹¶ PDF...");
        updateProgress(20);
        const merged = await PDFLib.PDFDocument.create();
        const dims = document.getElementById('pageSize').value === 'A3' ? [1190.55, 841.89] : [841.89, 595.28];
        const pageSize = document.getElementById('pageOrient').value === 'landscape' ? dims : [dims[1], dims[0]];

        for (let i=0; i<filesArray.length; i++) {
            updateProgress(20 + (i/filesArray.length)*70);
            const item = filesArray[i];
            if(item.type === 'pdf') {
                const doc = await PDFLib.PDFDocument.load(item.pdfBytes);
                const pages = await merged.copyPages(doc, doc.getPageIndices());
                pages.forEach(p => merged.addPage(p));
            } else {
                const img = item.file.type.includes('png') ? await merged.embedPng(await item.file.arrayBuffer()) : await merged.embedJpg(await item.file.arrayBuffer());
                const p = merged.addPage(pageSize);
                p.drawImage(img, { x: 0, y: 0, width: pageSize[0], height: pageSize[1] });
            }
        }
        saveAs(new Blob([await merged.save()]), `${document.getElementById('fileName').value}.pdf`);
        updateProgress(100);
        setTimeout(() => updateProgress(0, false), 800);
        msg("âœ¨ åˆå¹¶æˆåŠŸ");
    };

    function removeF(id) { filesArray = filesArray.filter(f => f.id !== id); renderUI(); }
    function msg(t) { document.getElementById('status').innerText = t; }

    new Sortable(document.getElementById('fileList'), { 
        animation: 150, handle: '.item-main', forceFallback: true,
        onStart: () => document.body.style.userSelect = 'none',
        onEnd: (evt) => {
            document.body.style.userSelect = '';
            const movedItem = filesArray.splice(evt.oldIndex, 1)[0];
            filesArray.splice(evt.newIndex, 0, movedItem);
        }
    });
</script>
</body>
</html>
